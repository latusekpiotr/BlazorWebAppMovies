@page "/movies"
@rendermode InteractiveServer
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.QuickGrid
@using BlazorWebAppMovies.Models
@using BlazorWebAppMovies.Data
@inject IDbContextFactory<BlazorWebAppMovies.Data.BlazorWebAppMoviesContext> DbFactory
@implements IAsyncDisposable

<PageTitle>Movies Collection</PageTitle>

<div class="page-header">
    <div class="container">
        <h1 class="page-title">üé¨ Movies Collection</h1>
        <p class="page-subtitle">Discover and manage your favorite movies</p>
    </div>
</div>

<div class="container">
    <div class="search-section">
        <div class="row align-items-center">
            <div class="col-md-6">
                <div class="search-container">
                    <span class="search-icon">üîç</span>
                    <input type="search" 
                           class="search-input" 
                           placeholder="Search movies by title..." 
                           @bind="titleFilter" 
                           @bind:event="oninput" />
                </div>
            </div>
            <div class="col-md-6 text-md-end mt-3 mt-md-0">
                <a href="movies/create" class="create-button">
                    ‚ûï Add New Movie
                </a>
            </div>
        </div>
    </div>

    <div class="table-container">
        <QuickGrid Class="table" Items="FilteredMovies" Pagination="pagination">
            <PropertyColumn Property="movie => movie.Title" Sortable="true" Title="üé¨ Title" />
            <PropertyColumn Property="movie => movie.ReleaseDate" Title="üìÖ Release Date" Format="yyyy-MM-dd" />
            <PropertyColumn Property="movie => movie.Genre" Title="üé≠ Genre" />
            <PropertyColumn Property="movie => movie.Price" Title="üí∞ Price" Format="C" />
            <PropertyColumn Property="movie => movie.Rating" Title="‚≠ê Rating" />

            <TemplateColumn Title="Actions" Context="movie">
                <div class="action-buttons">
                    <a href="@($"movies/edit?id={movie.Id}")" class="action-btn action-btn-edit">
                        ‚úèÔ∏è Edit
                    </a>
                    <a href="@($"movies/details?id={movie.Id}")" class="action-btn action-btn-details">
                        üëÅÔ∏è Details
                    </a>
                    <a href="@($"movies/delete?id={movie.Id}")" class="action-btn action-btn-delete">
                        üóëÔ∏è Delete
                    </a>
                </div>
            </TemplateColumn>
        </QuickGrid>
    </div>

    <Paginator State="pagination" />
</div>

@code {
    private PaginationState pagination = new PaginationState { ItemsPerPage = 5 };
    private string titleFilter = string.Empty;
    private BlazorWebAppMoviesContext context = default!;

    protected override void OnInitialized()
    {
        context = DbFactory.CreateDbContext();
    }

    private IQueryable<Movie> FilteredMovies => 
        context.Movie.Where(m => m.Title!.Contains(titleFilter));

    public async ValueTask DisposeAsync() => await context.DisposeAsync();
}
